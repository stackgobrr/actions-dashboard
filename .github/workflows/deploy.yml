name: Deploy to AWS S3/CloudFront

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  repository_dispatch:
    types: [lambda-updated]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  AWS_REGION: eu-west-2
  NODE_VERSION: '20'
  HOSTED_ZONE_ID: ${{ vars.HOSTED_ZONE_ID }}
  DOMAIN_NAME: ${{ vars.DOMAIN_NAME }}
  LAMBDA_S3_BUCKET_NAME: ${{ vars.LAMBDA_S3_BUCKET_NAME }}

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      tfvars_env: ${{ steps.env.outputs.tfvars_env }}
    steps:
      - name: Set environment
        id: env
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "environment=Production" >> "$GITHUB_OUTPUT"
            echo "tfvars_env=prod" >> "$GITHUB_OUTPUT"
          else
            echo "environment=Development" >> "$GITHUB_OUTPUT"
            echo "tfvars_env=dev" >> "$GITHUB_OUTPUT"
          fi
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Component Tests
        uses: ./.github/actions/react-component-test

  deploy-infrastructure:
    name: Deploy Infrastructure
    needs: [setup, test]
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}
    permissions:
      id-token: write
      contents: read
    outputs:
      oauth_start_url: ${{ steps.get-outputs.outputs.oauth_start_url }}
      oauth_callback_url: ${{ steps.get-outputs.outputs.oauth_callback_url }}
      website_url: ${{ steps.get-outputs.outputs.website_url }}
      s3_bucket: ${{ steps.get-outputs.outputs.s3_bucket }}
      distribution_id: ${{ steps.get-outputs.outputs.distribution_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: stackgobrr/common-github-actions/actions/aws-configure@main
        with:
          aws-region: ${{ env.AWS_REGION }}
          auth-method: 'static'
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.14.1'
          terraform_wrapper: false

      - name: Deploy infrastructure
        uses: stackgobrr/common-github-actions/actions/terraform-deploy@main
        with:
          terraform-version: '1.14.1'
          working-directory: 'infra'
          terraform-wrapper: 'false'
          auto-approve: 'true'
          environment: ${{ needs.setup.outputs.tfvars_env }}
        env:
          TF_VAR_domain_name: ${{ env.DOMAIN_NAME }}
          TF_VAR_hosted_zone_id: ${{ env.HOSTED_ZONE_ID }}
          TF_VAR_actions_dashboard_app_id: ${{ secrets.ACTIONS_DASHBOARD_APP_ID }}
          TF_VAR_app_private_key: ${{ secrets.ACTIONS_DASHBOARD_APP_PRIVATE_KEY }}
          TF_VAR_webhook_secret: ${{ secrets.ACTIONS_DASHBOARD_WEBHOOK_SECRET }}
          TF_VAR_oauth_client_id: ${{ secrets.ACTIONS_DASHBOARD_OAUTH_CLIENT_ID }}
          TF_VAR_oauth_client_secret: ${{ secrets.ACTIONS_DASHBOARD_OAUTH_CLIENT_SECRET }}
          TF_VAR_lambda_artifacts_bucket: ${{ env.LAMBDA_S3_BUCKET_NAME }}

      - name: Update Lambdas
        if: github.event_name == 'repository_dispatch'
        run: |
          cd infra
          BUCKET_NAME=${{ env.LAMBDA_S3_BUCKET_NAME }}
          ENVIRONMENT="${{ needs.setup.outputs.tfvars_env }}"

          MANIFEST=$(aws s3 cp "s3://${BUCKET_NAME}/manifest.json" -)

          for fn in $(echo "$MANIFEST" | jq -r '.lambdas | keys[]'); do
            S3_KEY=$(echo "$MANIFEST" | jq -r --arg fn "$fn" '.lambdas[$fn].package | sub("s3://[^/]+/"; "")')
            FUNCTION_NAME="actions-dashboard-${ENVIRONMENT}-${fn}"

            echo "Updating ${FUNCTION_NAME} with ${S3_KEY}"

            aws lambda update-function-code \
              --function-name "$FUNCTION_NAME" \
              --s3-bucket "$BUCKET_NAME" \
              --s3-key "$S3_KEY"
          done

      - name: Get Terraform outputs
        id: get-outputs
        run: |
          cd infra
          OAUTH_START_URL=$(terraform output -raw oauth_start_url)
          OAUTH_CALLBACK_URL=$(terraform output -raw oauth_callback_url)
          WEBSITE_URL=$(terraform output -raw website_url)
          S3_BUCKET=$(terraform output -raw s3_bucket_name)
          DISTRIBUTION_ID=$(terraform output -raw cloudfront_distribution_id)

          echo "oauth_start_url=$OAUTH_START_URL" >> $GITHUB_OUTPUT
          echo "oauth_callback_url=$OAUTH_CALLBACK_URL" >> $GITHUB_OUTPUT
          echo "website_url=$WEBSITE_URL" >> $GITHUB_OUTPUT
          echo "s3_bucket=$S3_BUCKET" >> $GITHUB_OUTPUT
          echo "distribution_id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT

      - name: Display Infrastructure Outputs
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸ—ï¸ Infrastructure Deployment Complete
          
          ### Deployed Resources (${{ needs.setup.outputs.environment }})
          
          | Resource | Value |
          |----------|-------|
          | ðŸŒ Website URL | \`${{ steps.get-outputs.outputs.website_url }}\` |
          | ðŸ” OAuth Start URL | \`${{ steps.get-outputs.outputs.oauth_start_url }}\` |
          | ðŸ” OAuth Callback URL | \`${{ steps.get-outputs.outputs.oauth_callback_url }}\` |
          | ðŸ“¦ S3 Bucket | \`${{ steps.get-outputs.outputs.s3_bucket }}\` |
          | â˜ï¸ CloudFront Distribution | \`${{ steps.get-outputs.outputs.distribution_id }}\` |
          
          ---
          EOF

  build:
    name: Build Application
    needs: deploy-infrastructure
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build application with SSE endpoint
        uses: stackgobrr/common-github-actions/actions/node-build-test@main
        with:
          node-version: ${{ env.NODE_VERSION }}
          working-directory: '.'
          build-command: 'npm run build'
          upload-artifacts: 'true'
          artifact-name: 'dist'
          artifact-path: 'dist/'
        env:
          VITE_SSE_ENDPOINT: /api/sse
          VITE_APP_SLUG: ${{ vars.APP_SLUG }}
          VITE_PLAUSIBLE_DOMAIN: ${{ env.DOMAIN_NAME }}

  deploy-frontend:
    name: Deploy Frontend
    needs: [setup, deploy-infrastructure, build]
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Configure AWS credentials
        uses: stackgobrr/common-github-actions/actions/aws-configure@main
        with:
          aws-region: ${{ env.AWS_REGION }}
          auth-method: 'static'
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Sync files to S3
        run: |
          aws s3 sync dist/ s3://${{ needs.deploy-infrastructure.outputs.s3_bucket }}/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "*.map"

          # Upload index.html separately with no-cache
          aws s3 cp dist/index.html s3://${{ needs.deploy-infrastructure.outputs.s3_bucket }}/index.html \
            --cache-control "public, max-age=0, must-revalidate"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ needs.deploy-infrastructure.outputs.distribution_id }} \
            --paths "/*"

      - name: Display deployment URLs
        run: |
          echo "ðŸš€ Dashboard deployed successfully!"
          echo "ðŸ“ Website URL: ${{ needs.deploy-infrastructure.outputs.website_url }}"
          echo "ðŸ” OAuth Start URL: ${{ needs.deploy-infrastructure.outputs.website_url }}/api/oauth/start"
          echo "ðŸ” OAuth Callback URL: ${{ needs.deploy-infrastructure.outputs.website_url }}/api/oauth/callback"

