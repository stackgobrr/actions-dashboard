name: Deploy to AWS S3/CloudFront

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  AWS_REGION: eu-west-2
  NODE_VERSION: '20'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
    steps:
      - name: Set environment
        id: env
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "environment=prod" >> "$GITHUB_OUTPUT"
          else
            echo "environment=dev" >> "$GITHUB_OUTPUT"
          fi
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Component Tests
        uses: ./.github/actions/react-component-test

  deploy-infrastructure:
    name: Deploy Infrastructure
    needs: [test, setup]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      sse_url: ${{ steps.get-outputs.outputs.sse_url }}
      webhook_url: ${{ steps.get-outputs.outputs.webhook_url }}
      oauth_start_url: ${{ steps.get-outputs.outputs.oauth_start_url }}
      oauth_callback_url: ${{ steps.get-outputs.outputs.oauth_callback_url }}
      website_url: ${{ steps.get-outputs.outputs.website_url }}
      s3_bucket: ${{ steps.get-outputs.outputs.s3_bucket }}
      distribution_id: ${{ steps.get-outputs.outputs.distribution_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: stackgobrr/common-github-actions/actions/aws-configure@main
        with:
          aws-region: ${{ env.AWS_REGION }}
          auth-method: 'static'
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.14.1'
          terraform_wrapper: false

      - name: Create S3 bucket for Lambda artifacts
        run: |
          cd infra
          terraform init \
          -backend-config="key=utils/actions-dashboard/${{ needs.setup.outputs.environment }}/terraform.tfstate"
          terraform apply -auto-approve -var-file=env/${{ needs.setup.outputs.environment }}.tfvars \
            -target=aws_s3_bucket.lambda_artifacts \
            -target=aws_s3_bucket_versioning.lambda_artifacts \
            -target=aws_s3_bucket_lifecycle_configuration.lambda_artifacts
        env:
          TF_VAR_domain_name: ${{ vars.DOMAIN_NAME }}
          TF_VAR_hosted_zone_id: ${{ vars.HOSTED_ZONE_ID }}
          TF_VAR_actions_dashboard_app_id: ${{ secrets.ACTIONS_DASHBOARD_APP_ID }}
          TF_VAR_app_private_key: ${{ secrets.ACTIONS_DASHBOARD_APP_PRIVATE_KEY }}
          TF_VAR_webhook_secret: ${{ secrets.ACTIONS_DASHBOARD_WEBHOOK_SECRET }}
          TF_VAR_oauth_client_id: ${{ secrets.ACTIONS_DASHBOARD_OAUTH_CLIENT_ID }}
          TF_VAR_oauth_client_secret: ${{ secrets.ACTIONS_DASHBOARD_OAUTH_CLIENT_SECRET }}

      - name: Get Lambda artifacts bucket name
        id: bucket
        run: |
          cd infra
          BUCKET_NAME=$(terraform output -raw lambda_artifacts_bucket)
          echo "name=$BUCKET_NAME" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Package and upload Lambda functions
        run: |
          cd api
          
          for dir in */; do
            func_name=$(basename "$dir")
            echo "Packaging ${func_name}..."
            
            cd "$dir"
            
            # Install dependencies if package.json exists
            if [ -f package.json ]; then
              npm install --production
              rm -rf package-lock.json
            fi
            
            # Create zip archive
            zip -r "${func_name}.zip" . -x "*.git*" -x "node_modules/.cache/*"
            
            # Upload to S3
            aws s3 cp "${func_name}.zip" "s3://${{ steps.bucket.outputs.name }}/${func_name}.zip"
            
            cd ..
          done

      - name: Deploy infrastructure
        uses: stackgobrr/common-github-actions/actions/terraform-deploy@main
        with:
          terraform-version: '1.14.1'
          working-directory: 'infra'
          terraform-wrapper: 'false'
          auto-approve: 'true'
          environment: ${{ needs.setup.outputs.environment }}
        env:
          TF_VAR_domain_name: ${{ vars.DOMAIN_NAME }}
          TF_VAR_hosted_zone_id: ${{ vars.HOSTED_ZONE_ID }}
          TF_VAR_actions_dashboard_app_id: ${{ secrets.ACTIONS_DASHBOARD_APP_ID }}
          TF_VAR_app_private_key: ${{ secrets.ACTIONS_DASHBOARD_APP_PRIVATE_KEY }}
          TF_VAR_webhook_secret: ${{ secrets.ACTIONS_DASHBOARD_WEBHOOK_SECRET }}
          TF_VAR_oauth_client_id: ${{ secrets.ACTIONS_DASHBOARD_OAUTH_CLIENT_ID }}
          TF_VAR_oauth_client_secret: ${{ secrets.ACTIONS_DASHBOARD_OAUTH_CLIENT_SECRET }}

      - name: Get Terraform outputs
        id: get-outputs
        run: |
          cd infra
          SSE_URL=$(terraform output -raw sse_handler_url)
          WEBHOOK_URL=$(terraform output -raw webhook_receiver_url)
          OAUTH_START_URL=$(terraform output -raw oauth_start_url)
          OAUTH_CALLBACK_URL=$(terraform output -raw oauth_callback_url)
          WEBSITE_URL=$(terraform output -raw website_url)
          S3_BUCKET=$(terraform output -raw s3_bucket_name)
          DISTRIBUTION_ID=$(terraform output -raw cloudfront_distribution_id)

          echo "sse_url=$SSE_URL" >> $GITHUB_OUTPUT
          echo "webhook_url=$WEBHOOK_URL" >> $GITHUB_OUTPUT
          echo "oauth_start_url=$OAUTH_START_URL" >> $GITHUB_OUTPUT
          echo "oauth_callback_url=$OAUTH_CALLBACK_URL" >> $GITHUB_OUTPUT
          echo "website_url=$WEBSITE_URL" >> $GITHUB_OUTPUT
          echo "s3_bucket=$S3_BUCKET" >> $GITHUB_OUTPUT
          echo "distribution_id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT

  build:
    name: Build Application
    needs: deploy-infrastructure
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build application with SSE endpoint
        uses: stackgobrr/common-github-actions/actions/node-build-test@main
        with:
          node-version: ${{ env.NODE_VERSION }}
          working-directory: '.'
          build-command: 'npm run build'
          upload-artifacts: 'true'
          artifact-name: 'dist'
          artifact-path: 'dist/'
        env:
          VITE_SSE_ENDPOINT: /api/sse
          VITE_APP_SLUG: ${{ vars.APP_SLUG }}
          VITE_PLAUSIBLE_DOMAIN: ${{ vars.DOMAIN_NAME }}

  deploy-frontend:
    name: Deploy Frontend
    needs: [deploy-infrastructure, build]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Configure AWS credentials
        uses: stackgobrr/common-github-actions/actions/aws-configure@main
        with:
          aws-region: ${{ env.AWS_REGION }}
          auth-method: 'static'
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Sync files to S3
        run: |
          aws s3 sync dist/ s3://${{ needs.deploy-infrastructure.outputs.s3_bucket }}/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "*.map"

          # Upload index.html separately with no-cache
          aws s3 cp dist/index.html s3://${{ needs.deploy-infrastructure.outputs.s3_bucket }}/index.html \
            --cache-control "public, max-age=0, must-revalidate"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ needs.deploy-infrastructure.outputs.distribution_id }} \
            --paths "/*"

      - name: Display deployment URLs
        run: |
          echo "üöÄ Dashboard deployed successfully!"
          echo "üìç Website URL: ${{ needs.deploy-infrastructure.outputs.website_url }}"
          echo "üîó Webhook URL: ${{ needs.deploy-infrastructure.outputs.website_url }}api/webhook"
          echo "üì° SSE URL: ${{ needs.deploy-infrastructure.outputs.website_url }}api/sse"
          echo "üîê OAuth Start URL: ${{ needs.deploy-infrastructure.outputs.website_url }}api/oauth/start"
          echo "üîê OAuth Callback URL: ${{ needs.deploy-infrastructure.outputs.website_url }}api/oauth/callback"
          echo ""
          echo "‚ö†Ô∏è  MANUAL STEP: Update GitHub App webhook URL to:"
          echo "   ${{ needs.deploy-infrastructure.outputs.website_url }}api/webhook"
          echo "   Visit: https://github.com/settings/apps/actions-dashboard-by-stackgobrr"

