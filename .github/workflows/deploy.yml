name: Deploy to AWS S3/CloudFront

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  AWS_REGION: eu-west-2
  NODE_VERSION: '20'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Component Tests
        uses: ./.github/actions/react-component-test

  deploy-infrastructure:
    name: Deploy Infrastructure
    needs: test
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      sse_url: ${{ steps.get-outputs.outputs.sse_url }}
      webhook_url: ${{ steps.get-outputs.outputs.webhook_url }}
      website_url: ${{ steps.get-outputs.outputs.website_url }}
      s3_bucket: ${{ steps.get-outputs.outputs.s3_bucket }}
      distribution_id: ${{ steps.get-outputs.outputs.distribution_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: stackgobrr/common-github-actions/actions/aws-configure@main
        with:
          aws-region: ${{ env.AWS_REGION }}
          auth-method: 'static'
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Deploy infrastructure
        uses: stackgobrr/common-github-actions/actions/terraform-deploy@main
        with:
          terraform-version: '1.14.1'
          working-directory: 'infra'
          terraform-wrapper: 'false'
          auto-approve: 'true'
        env:
          TF_VAR_domain_name: ${{ vars.DOMAIN_NAME }}
          TF_VAR_hosted_zone_id: ${{ vars.HOSTED_ZONE_ID }}
          TF_VAR_webhook_secret: ${{ secrets.WEBHOOK_SECRET }}

      - name: Get Terraform outputs
        id: get-outputs
        run: |
          cd infra
          SSE_URL=$(terraform output -raw sse_handler_url)
          WEBHOOK_URL=$(terraform output -raw webhook_receiver_url)
          WEBSITE_URL=$(terraform output -raw website_url)
          S3_BUCKET=$(terraform output -raw s3_bucket_name)
          DISTRIBUTION_ID=$(terraform output -raw cloudfront_distribution_id)

          echo "sse_url=$SSE_URL" >> $GITHUB_OUTPUT
          echo "webhook_url=$WEBHOOK_URL" >> $GITHUB_OUTPUT
          echo "website_url=$WEBSITE_URL" >> $GITHUB_OUTPUT
          echo "s3_bucket=$S3_BUCKET" >> $GITHUB_OUTPUT
          echo "distribution_id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT

  build:
    name: Build Application
    needs: deploy-infrastructure
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build application with SSE endpoint
        uses: stackgobrr/common-github-actions/actions/node-build-test@main
        with:
          node-version: ${{ env.NODE_VERSION }}
          working-directory: '.'
          build-command: 'npm run build'
          upload-artifacts: 'true'
          artifact-name: 'dist'
          artifact-path: 'dist/'
        env:
          VITE_SSE_ENDPOINT: ${{ needs.deploy-infrastructure.outputs.sse_url }}
          VITE_APP_SLUG: ${{ vars.APP_SLUG }}

  deploy-frontend:
    name: Deploy Frontend
    needs: [deploy-infrastructure, build]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Configure AWS credentials
        uses: stackgobrr/common-github-actions/actions/aws-configure@main
        with:
          aws-region: ${{ env.AWS_REGION }}
          auth-method: 'static'
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Sync files to S3
        run: |
          aws s3 sync dist/ s3://${{ needs.deploy-infrastructure.outputs.s3_bucket }}/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "*.map"

          # Upload index.html separately with no-cache
          aws s3 cp dist/index.html s3://${{ needs.deploy-infrastructure.outputs.s3_bucket }}/index.html \
            --cache-control "public, max-age=0, must-revalidate"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ needs.deploy-infrastructure.outputs.distribution_id }} \
            --paths "/*"

      - name: Display deployment URLs
        run: |
          echo "üöÄ Dashboard deployed successfully!"
          echo "üìç Website URL: ${{ needs.deploy-infrastructure.outputs.website_url }}"
          echo "üîó Webhook URL: ${{ needs.deploy-infrastructure.outputs.webhook_url }}"
          echo "üì° SSE URL: ${{ needs.deploy-infrastructure.outputs.sse_url }}"
